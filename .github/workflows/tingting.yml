# This is a basic workflow to help you get started with Actions

name: Deploy to EC2

# Controls when the workflow will run
on:
  # Triggers the workflow on push or pull request events but only for the "main" branch
  push:
    branches: [ "staging" ]
  pull_request:
    branches: [ "staging" ]

  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:

# A workflow run is made up of one or more jobs that can run sequentially or in parallel
jobs:
  # This workflow contains a single job called "build"
  deploy:
    name: Deploy to EC2 Self-Hosted Runner
    runs-on: self-hosted

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Generate auth_service env
        run: echo "${{ secrets.AUTH_SERVICE_ENV }}" > ./auth_service/.env.development.local

      - name: Generate user_service env
        run: echo "${{ secrets.USER_SERVICE_ENV }}" > ./user_service/.env.development.local

      - name: Generate chat_service env
        run: echo "${{ secrets.CHAT_SERVICE_ENV }}" > ./chat_service/.env

      - name: Generate notification_service env
        run: echo "${{ secrets.NOTIFICATION_SERVICE_ENV }}" > ./notification_service/.env

      - name: Generate cloud_service env
        run: echo "${{ secrets.CLOUD_SERVICE_ENV }}" > ./cloud-service/.env

      # Tiáº¿p tá»¥c vá»›i cÃ¡c file khÃ¡c náº¿u cÃ³...

      - name: Pull latest code & restart services
        run: |
          echo "ğŸ“¥ Pulling latest code..."
          git pull origin staging

          echo "ğŸ” Restarting docker-compose services..."
          docker-compose down
          docker-compose build
          docker-compose up -d --remove-orphans

          echo "âœ… Deployment finished!"

          sudo ./svc.sh start
